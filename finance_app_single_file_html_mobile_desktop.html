<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Financy — Budget mobile & desktop</title>
  <meta name="theme-color" content="#0b5bff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Financy" />
  <!-- iOS Home Screen Icon (PNG base64, 180x180). Se vuoi sostituirla in futuro, cambia solo questo href -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAABb0z3TAAAACXBIWXMAAAsSAAALEgHS3X78AAAIiElEQVR4nO2dW4iVWRjHf2o2xVq8Jm5wgrmGk6wN5fJm5bD1Qh5K3y0fW0zJ3cH4q3v6Tt3R6e5f8WcQmCwKQySgC5n3m0B7mY0C8C6Jb7EJqk2bZp7n9t4q8g8p3z7z+9z1VQqBQBQKBRJq2m1uWwP6mR8r2iIuR7v8X8b3m6c5cK2nGqg1Yc8lQmUo9d9q2p6CwP0r7g7G0g8Q2fB3QxK3hKZQ2+qg3m2yqgkqg2Vv1m7Gnx4Xw2k7h0n4m5R5Vqz8Zg0VgkqgNwPy1V8rYl1nH1U8m+1nO7M1l3zJY6kJ1r5yYkqkQ3nFhKpQ4Z+9fW0k7n2Y6sZ3g2JrF0roQ3Hc8b5h2p9m6t8gYbQ7dJ3w1q2b0m6c1j5wq6H7y9mQwWZK3V1y9m8xg1mkcWcXc4m8Z4cK1k1j9y2x2mG6dNQJmA9e3wCw2bS0H3qgkA6l0c+o0b0m7m2t7r2qM2t1m8n2u8w0m0WJH2P9mQGQk2mV0p3bP7bq8mQ0b7s4w2E0bGQx+o+zjnGQzOQw5x4r/1f2W4b8u1xT8v8y2c7l1dW7y8pF8rGxk8oO4mXG6Hq7+e4m7mM3QwQZsYtQ9fZLq3l9fK2l+f3Q0o8YxUj9m8ZCqQk2m0y3U6g8H2h+H8h2YqX/5cXg8c7kz6e3JXoYw9o8w7o9o8o8p8e4b8h6n8w8n8q8v8z8k8WgQqBQCBQKBT4nY9S5Vv/2gJ7c1zGkYw5qQ8mJ3yV6k2w5Y7qsxw5b3n7VdUu8q2a2wCkQKkqgQm9Kp9f3Q3XzX2mC9n6n5u2GkYQ6U0o9mWcZbNn2E8f8s7J8m7b7iBz0W4xJpZ5c6TjJm4b7t6U2o9a9XnZrJf8+u6u3U2m5t8l8ixb6q9m0gkqgR3b8w8o9q8n9l0v9e8j8x8c8b8d8P8WkP8KkP8YkP8QkP8AkP8SkP8MUc7UFg0k6yBt2w2H3VQ2m6QwH7Q+o+RESETLOGO" />
  <!-- Manifest inserito a runtime -->
  <link id="manifestLink" rel="manifest" href="#" />
  <style>
    :root{--bg:#f5f7ff;--card:#ffffff;--text:#0f172a;--muted:#5b6b8a;--line:#e3e8ff;--accent:#0b5bff;--ok:#10b981;--bad:#ef4444}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,#0b5bff 0%,#2c6dff 100%)}
    .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
    .topbar{display:flex;align-items:center;gap:12px;color:#fff}
    .logo{width:40px;height:40px;border-radius:12px;background:rgba(255,255,255,.12);display:grid;place-items:center;border:1px solid rgba(255,255,255,.2)}
    .logo svg{width:22px;height:22px}
    .title-btn{background:none;border:none;color:#fff;font-weight:800;font-size:18px;letter-spacing:.3px;cursor:pointer}
    .chips{margin-left:auto;display:flex;gap:8px}
    .btn,.chip{padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .btn:active{transform:translateY(1px)}.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    main{padding:16px}.grid{display:grid;gap:12px}.grid-2{grid-template-columns:repeat(2,1fr)}
    @media(min-width:900px){.grid-2{grid-template-columns:repeat(4,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .title{font-weight:700}.muted{color:var(--muted);font-size:12px}.kpi{font-size:22px;font-weight:800}
    .row{display:flex;gap:8px;align-items:center}.input{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left}td.right{text-align:right}
    .bar{height:10px;background:#e7ebff;border-radius:999px;overflow:hidden;position:relative}
    .spent{position:absolute;left:0;top:0;bottom:0;background:#ef4444}
    .remain{position:absolute;top:0;bottom:0;right:0;background:#0b5bff}
    nav{position:fixed;bottom:0;left:0;right:0;z-index:40;background:rgba(255,255,255,.96);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:8px}
    .tab{padding:10px;border-radius:12px;text-align:center;color:var(--muted)}.tab.active{color:var(--text);font-weight:700;background:#eaf1ff}
    .safe{height:72px}.section{display:none}.section.active{display:block}
    .danger{color:#b91c1c}
    /* Categorie (pill) */
    .pill{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:6px 8px}
    .pill input{border:none;outline:none;width:100%;background:transparent}
    .icon-btn{width:28px;height:28px;border-radius:8px;border:1px solid var(--line);display:grid;place-items:center;background:#fff}
    .icon-btn:active{transform:translateY(1px)}.dragging{opacity:.6}
    /* Splash */
    #splash{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(120% 120% at 30% 20%,#5aa0ff 0%,#0b5bff 60%,#031a66 100%);color:#fff;z-index:60}
    .splash-card{display:flex;flex-direction:column;align-items:center;gap:12px}
    .splash-logo{width:88px;height:88px;border-radius:24px;background:rgba(255,255,255,.1);display:grid;place-items:center;border:1px solid rgba(255,255,255,.2)}
    .fade-out{animation:fade .6s ease forwards}@keyframes fade{to{opacity:0;visibility:hidden}}
  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash"><div class="splash-card"><div class="splash-logo"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round"><path d="M6 8h9"/><path d="M6 12h7"/><path d="M16.5 5.5c-3-1.2-7 .8-8 4.5-1.2 4.2 2 8.5 6.4 8.5 2.4 0 4.1-1.1 5.1-2.5"/></svg></div><div style="font-weight:800;font-size:20px;letter-spacing:.3px">Financy</div><div style="opacity:.9">Controllo chiaro • Scelte migliori</div></div></div>

  <!-- Header -->
  <header>
    <div class="wrap topbar">
      <div class="logo" title="Financy" id="btnHome"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round"><path d="M6 8h9"/><path d="M6 12h7"/><path d="M16.5 5.5c-3-1.2-7 .8-8 4.5-1.2 4.2 2 8.5 6.4 8.5 2.4 0 4.1-1.1 5.1-2.5"/></svg></div>
      <button class="title-btn" id="titleHome">Financy</button>
      <div class="chips">
        <button id="btnGoTx" class="btn" title="Vai a Transazioni">Transazioni</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="dash" class="section active">
      <div class="grid grid-2">
        <div class="card">
          <div class="muted">Mese attivo</div>
          <div class="row" style="margin-top:6px">
            <select id="activeMonth" class="input"></select>
            <select id="activeYear" class="input" style="max-width:120px"></select>
          </div>
        </div>
        <div class="card"><div class="muted">Entrate mese</div><div id="kpiIncome" class="kpi">€0</div></div>
        <div class="card"><div class="muted">Uscite mese</div><div id="kpiExpense" class="kpi">€0</div></div>
        <div class="card"><div class="muted">Saldo Contanti</div><div id="kpiCash" class="kpi">€0</div></div>
        <div class="card"><div class="muted">Saldo Carta</div><div id="kpiCard" class="kpi">€0</div></div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div class="card">
          <div class="title" style="margin-bottom:8px">Spese per categoria (mese)</div>
          <div id="catList" class="grid" style="grid-template-columns:1fr;gap:10px"></div>
        </div>
      </div>
    </section>

    <!-- TRANSAZIONI -->
    <section id="tx" class="section">
      <div class="card">
        <div class="title">Aggiungi movimento</div>
        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
          <div><div class="muted">Data</div><input id="txDate" type="date" class="input"></div>
          <div><div class="muted">Tipo</div><select id="txType" class="input"><option>Entrata</option><option>Uscita</option></select></div>
          <div><div class="muted">Account</div><select id="txAccount" class="input"><option>Contanti</option><option>Carta</option></select></div>
          <div><div class="muted">Categoria</div><select id="txCategory" class="input"></select></div>
          <div><div class="muted">Importo</div><input id="txAmount" type="number" inputmode="decimal" min="0" step="0.01" class="input" placeholder="0,00"></div>
          <div style="grid-column:1/-1"><div class="muted">Note</div><input id="txNote" class="input" placeholder="(opzionale)"></div>
          <div class="row" style="grid-column:1/-1;gap:10px"><button id="btnAdd" class="btn btn-primary">Aggiungi</button><button id="btnClear" class="btn">Pulisci</button></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div class="title">Movimenti</div>
          <div class="row"><input id="searchTx" class="input" placeholder="Cerca…" style="max-width:200px"><select id="filterType" class="input" style="max-width:140px"><option value="">Tutti</option><option>Entrata</option><option>Uscita</option></select></div>
        </div>
        <div style="overflow:auto;margin-top:6px">
          <table>
            <thead><tr class="muted"><th>Data</th><th>Tipo</th><th>Account</th><th>Categoria</th><th class="right">Importo</th><th>Note</th><th class="right">Azioni</th></tr></thead>
            <tbody id="txTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BUDGET -->
    <section id="budget" class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="title">Budget — <span id="budgetMonthLabel"></span></div>
          <div class="row" style="gap:8px">
            <button id="btnAddBudget" class="btn">+ Aggiungi budget</button>
            <button id="btnResetBudget" class="btn" style="background:#fee2e2;border-color:#fecaca;color:#b91c1c">Azzera budget</button>
          </div>
        </div>
        <div id="budgetList" class="grid" style="grid-template-columns:1fr 1fr; gap:10px; margin-top:10px"></div>
      </div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section id="settings" class="section">
      <div class="card">
        <div class="title">Preferenze</div>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div style="grid-column:1/-1;display:flex;justify-content:center"><select id="currency" class="input" style="max-width:220px;text-align:center"></select></div>
          <div style="grid-column:1/-1">
            <div class="muted">Categorie (trascina per riordinare)</div>
            <div id="categoriesEditor" class="grid" style="grid-template-columns:1fr 1fr;gap:8px"></div>
            <div class="row" style="margin-top:8px"><button id="btnAddCategory" class="btn">+ Aggiungi categoria</button></div>
          </div>
        </div>
        <div class="row" style="gap:10px;margin-top:10px"><button id="btnSaveSettings" class="btn btn-primary">Salva impostazioni</button><button id="btnResetAll" class="btn" style="background:#fee2e2;border-color:#fecaca;color:#b91c1c">Reset totale</button></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">Esporta</div>
        <div class="row" style="gap:8px;margin-top:6px"><button id="btnExportPDF" class="btn btn-primary">Esporta PDF</button></div>
        <div class="muted" style="margin-top:8px">Crea un PDF riepilogativo del mese corrente con KPI e spese per categoria.</div>
      </div>
    </section>
  </main>

  <!-- Tabs -->
  <nav>
    <div class="wrap tabs">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="budget">Budget</button>
      <button class="tab" data-tab="settings">Impostazioni</button>
    </div>
  </nav>
  <div class="safe"></div>

  <script>
  // ====== Stato & util ======
  const STORE_KEY='financy_state_v3';
  const defaultState=()=>({
    currency:'EUR',
    categories:['Casa','Spesa alimentare','Ristoranti','Trasporti','Auto','Salute','Abbonamenti','Tempo libero','Regali/Donazioni','Bollette/Utenze','Istruzione/Formazione','Lavoro','Vacanze/Viaggi','Figli/Famiglia','Altro'],
    transactions:[], // {id,date,type,account,category,amount,note}
    budgets:{},
    activeMonth:new Date().toLocaleString('it-IT',{month:'long'}),
    activeYear:new Date().getFullYear()
  });
  let state=load();
  function load(){try{return JSON.parse(localStorage.getItem(STORE_KEY))||defaultState();}catch(e){return defaultState();}}
  function save(){localStorage.setItem(STORE_KEY,JSON.stringify(state));}
  const $=id=>document.getElementById(id);
  function monthKey(y,name){const m=['gennaio','febbraio','marzo','aprile','maggio','giugno','luglio','agosto','settembre','ottobre','novembre','dicembre'];const i=m.indexOf((name||'').toLowerCase());return `${y}-${String(i+1).padStart(2,'0')}`;}
  function uid(){return Math.random().toString(36).slice(2,9);} 
  function money(v){return new Intl.NumberFormat('it-IT',{style:'currency',currency:state.currency}).format(v||0);} 

  // ====== Init selettori ======
  function initSelectors(){
    const months=['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    $('activeMonth').innerHTML=months.map(m=>`<option ${m===state.activeMonth?'selected':''}>${m}</option>`).join('');
    const y=new Date().getFullYear();
    $('activeYear').innerHTML=Array.from({length:5},(_,k)=>y-3+k).map(Y=>`<option ${Y===state.activeYear?'selected':''}>${Y}</option>`).join('');
    $('txCategory').innerHTML=state.categories.map(c=>`<option>${c}</option>`).join('');
    $('currency').innerHTML=['EUR','USD','GBP','CHF'].map(v=>`<option value="${v}" ${state.currency===v?'selected':''}>${({EUR:'Euro (€)',USD:'Dollaro ($)',GBP:'Sterlina (£)',CHF:'Franco (CHF)'}[v])}</option>`).join('');
    $('budgetMonthLabel').textContent=`${state.activeMonth} ${state.activeYear}`;
    renderCategoriesEditor();
  }

  // ====== KPI ======
  function monthTotals(){const key=monthKey(state.activeYear,state.activeMonth);let inc=0,exp=0,cash=0,card=0;state.transactions.forEach(t=>{const d=new Date(t.date);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;if(k===key){if(t.type==='Entrata'){inc+=t.amount;if(t.account==='Contanti')cash+=t.amount;else card+=t.amount;}else{exp+=t.amount;if(t.account==='Contanti')cash-=t.amount;else card-=t.amount;}}});return {inc,exp,cash,card};}
  function renderKPI(){const {inc,exp,cash,card}=monthTotals();$('kpiIncome').textContent=money(inc);$('kpiExpense').textContent=money(exp);$('kpiCash').textContent=money(cash);$('kpiCard').textContent=money(card);} 

  // ====== Spese per categoria ======
  function spendByCategory(){const key=monthKey(state.activeYear,state.activeMonth);const m=Object.fromEntries(state.categories.map(c=>[c,0]));state.transactions.forEach(t=>{const d=new Date(t.date);const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;if(k===key&&t.type==='Uscita')m[t.category]=(m[t.category]||0)+t.amount;});return m;}
  function renderCatList(){const wrap=$('catList');const spent=spendByCategory();const key=monthKey(state.activeYear,state.activeMonth);const b=state.budgets[key]||{};wrap.innerHTML=state.categories.map(cat=>{const s=spent[cat]||0;const bud=b[cat]||0;const pct=bud>0?Math.min(100,Math.round(s/bud*100)):0;const remainPct=bud>0?Math.max(0,100-pct):0;return `<div><div class="row" style="justify-content:space-between"><div>${cat}</div><div class="muted">${money(s)}${bud?' / '+money(bud):''}</div></div><div class="bar" style="margin-top:6px"><div class="spent" style="width:${pct}%"></div><div class="remain" style="width:${remainPct}%"></div></div></div>`;}).join('');}

  // ====== Transazioni ======
  function renderTx(){const q=($('searchTx').value||'').toLowerCase();const ft=$('filterType').value;const cur=new Intl.NumberFormat('it-IT',{style:'currency',currency:state.currency});const rows=state.transactions.filter(t=>!ft||t.type===ft).filter(t=>`${t.category} ${t.note||''}`.toLowerCase().includes(q)).sort((a,b)=>new Date(b.date)-new Date(a.date));$('txTable').innerHTML=rows.map(t=>`<tr><td>${new Date(t.date).toLocaleDateString('it-IT')}</td><td>${t.type}</td><td>${t.account}</td><td>${t.category}</td><td class='right'>${cur.format(t.amount)}</td><td>${t.note||''}</td><td class='right'><button class='btn' onclick="editTx('${t.id}')">Modifica</button> <button class='btn' style='background:#fee2e2;border-color:#fecaca;color:#b91c1c' onclick="delTx('${t.id}')">Elimina</button></td></tr>`).join('');}
  function addTx(){const date=$('txDate').value;const amount=parseFloat($('txAmount').value||'0');if(!date||!amount||amount<0)return;const tx={id:uid(),date,type:$('txType').value,account:$('txAccount').value,category:$('txCategory').value,amount,note:$('txNote').value.trim()};state.transactions.push(tx);save();clearTx();renderAll();show('tx');}
  function clearTx(){$('txDate').value='';$('txType').value='Entrata';$('txAccount').value='Contanti';$('txCategory').selectedIndex=0;$('txAmount').value='';$('txNote').value='';}
  function editTx(id){const t=state.transactions.find(x=>x.id===id);if(!t)return;$('txDate').value=t.date.slice(0,10);$('txType').value=t.type;$('txAccount').value=t.account;$('txCategory').value=t.category;$('txAmount').value=t.amount;$('txNote').value=t.note||'';delTx(id);} 
  function delTx(id){state.transactions=state.transactions.filter(t=>t.id!==id);save();renderAll();}

  // ====== Budget ======
  function renderBudget(){const wrap=$('budgetList');const key=monthKey(state.activeYear,state.activeMonth);const spent=spendByCategory();const monthBudget=state.budgets[key]||{};wrap.innerHTML=state.categories.map(cat=>{const b=monthBudget[cat]||0;const s=spent[cat]||0;const diff=b-s;const pct=b>0?Math.min(100,Math.round(s/b*100)):0;return `<div class='card'><div class='row' style='justify-content:space-between'><b>${cat}</b><span class='muted'>${money(s)} / ${money(b)}</span></div><div class='bar' style='margin-top:6px'><div class='spent' style='width:${pct}%'></div><div class='remain' style='width:${Math.max(0,100-pct)}%'></div></div><div class='row' style='gap:8px;margin-top:6px'><input type='number' step='0.01' min='0' class='input' value='${b}' oninput="setBudget('${cat}', this.value)"><div class='muted' style='margin-left:auto'>Diff: <b class='${diff>=0?'':'danger'}'>${money(diff)}</b></div></div></div>`;}).join('');}
  function setBudget(cat,val){const key=monthKey(state.activeYear,state.activeMonth);state.budgets[key]=state.budgets[key]||{};state.budgets[key][cat]=parseFloat(val||'0')||0;save();renderBudget();renderKPI();}
  function addBudgetPrompt(){const cats=state.categories.slice();const sel=prompt('Categoria per cui impostare un budget (scrivi esattamente il nome):
'+cats.join(', '));if(!sel||!cats.includes(sel))return;const v=parseFloat(prompt('Importo budget per '+sel+' (es. 100):')||'0');const key=monthKey(state.activeYear,state.activeMonth);state.budgets[key]=state.budgets[key]||{};state.budgets[key][sel]=v;save();renderBudget();}

  // ====== Impostazioni (categorie) ======
  function renderCategoriesEditor(){const box=$('categoriesEditor');box.innerHTML=state.categories.map((c,i)=>`<div class='pill' draggable='true' data-i='${i}'><input value="${c}" oninput="updateCategory(${i}, this.value)" onblur="refreshAfterEdit()"/><button class='icon-btn' title='Elimina' onclick='removeCategory(${i})'>−</button></div>`).join('');box.querySelectorAll('.pill').forEach(el=>{el.addEventListener('dragstart',e=>{el.classList.add('dragging');e.dataTransfer.setData('text/plain',el.dataset.i);});el.addEventListener('dragend',()=>el.classList.remove('dragging'));});box.addEventListener('dragover',e=>{e.preventDefault();const dragging=box.querySelector('.dragging');if(!dragging)return;const after=Array.from(box.querySelectorAll('.pill:not(.dragging)')).find(p=>e.clientY<=p.getBoundingClientRect().top+p.offsetHeight/2);if(after)box.insertBefore(dragging,after);else box.appendChild(dragging);});box.addEventListener('drop',()=>{const newOrder=Array.from(box.querySelectorAll('.pill')).map(p=> state.categories[parseInt(p.dataset.i,10)]);state.categories=newOrder;save();initSelectors();renderAll();});}
  function addCategory(){state.categories.push('Nuova categoria');save();renderCategoriesEditor();initSelectors();renderCatList();}
  function removeCategory(i){state.categories.splice(i,1);save();renderCategoriesEditor();initSelectors();renderCatList();}
  function updateCategory(i,val){state.categories[i]=val;save();/* niente re-render per non chiudere tastiera */}
  function refreshAfterEdit(){initSelectors();renderCatList();}
  function saveSettings(){state.currency=$('currency').value;save();initSelectors();renderAll();}
  function resetAll(){if(!confirm('Sicura/o? Cancellerai tutti i dati.'))return;state=defaultState();save();initSelectors();renderAll();}

  // ====== Export PDF ======
  function exportPDF(){const {inc,exp,cash,card}=monthTotals();const spent=spendByCategory();const key=monthKey(state.activeYear,state.activeMonth);const bud=state.budgets[key]||{};const html=`<!doctype html><html><head><meta charset='utf-8'><title>Financy PDF</title><style>body{font-family:Arial,sans-serif;padding:24px}h1{margin:0 0 8px}table{width:100%;border-collapse:collapse;margin-top:12px}th,td{border:1px solid #ddd;padding:8px;text-align:left}</style></head><body><h1>Financy — Riepilogo ${state.activeMonth} ${state.activeYear}</h1><p><b>Entrate:</b> ${money(inc)} &nbsp; <b>Uscite:</b> ${money(exp)} &nbsp; <b>Saldo Contanti:</b> ${money(cash)} &nbsp; <b>Saldo Carta:</b> ${money(card)}</p><h2>Spese per categoria</h2><table><thead><tr><th>Categoria</th><th>Speso</th><th>Budget</th></tr></thead><tbody>${state.categories.map(c=>`<tr><td>${c}</td><td>${money(spent[c]||0)}</td><td>${money(bud[c]||0)}</td></tr>`).join('')}</tbody></table></body></html>`;const w=window.open('','_blank');w.document.write(html);w.document.close();w.focus();w.print();}

  // ====== Navigazione ======
  function show(tab){['dash','tx','budget','settings'].forEach(id=>{const s=document.getElementById(id);if(s)s.classList.toggle('active',id===tab);const t=document.querySelector(`[data-tab="${id}"]`);if(t)t.classList.toggle('active',id===tab);});if(tab==='budget')renderBudget();if(tab==='dash')renderCatList();}
  function bind(){
    $('btnAdd').onclick=addTx;$('btnClear').onclick=clearTx;$('searchTx').oninput=renderTx;$('filterType').onchange=renderTx;
    $('activeMonth').onchange=e=>{state.activeMonth=e.target.value;save();initSelectors();renderAll();};
    $('activeYear').onchange=e=>{state.activeYear=parseInt(e.target.value,10);save();initSelectors();renderAll();};
    $('btnResetBudget').onclick=()=>{state.budgets[monthKey(state.activeYear,state.activeMonth)]={};save();renderBudget();};
    $('btnAddBudget').onclick=addBudgetPrompt;
    $('btnSaveSettings').onclick=saveSettings;$('btnResetAll').onclick=resetAll;$('btnExportPDF').onclick=exportPDF;
    document.querySelectorAll('[data-tab]').forEach(b=>b.onclick=()=>show(b.dataset.tab));
    $('btnGoTx').onclick=()=>show('tx');$('btnHome').onclick=()=>show('dash');$('titleHome').onclick=()=>show('dash');
  }

  // ====== Icona/Manifest/Service Worker ======
  (function(){
    // Icona PNG blu con logo stilizzato (base64). Sostituibile facilmente qui sotto se vuoi un 1024x1024.
    const iconPng='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPAAAADwCAYAAAA+VemQAAAACXBIWXMAAAsSAAALEgHS3X78AAAHl0lEQVR4nO2dS47kQBRF/9S0k8dK0QzqgYqzE9QK9B1lYz9aYw7kG9Jf0WlK2bqg7Qb9s3oE1mQJgqBLmZkIc5L3mZQ4xwYwYv0v3pJr3mU4vK3m4qv/7n3gYb2YI2b8CwBAGD6jS7b2r0fQFq2bQqlf2aZJgk/0m4XcTzVvF1m4lq1b5n3n2h0j1v1Y9Wm1i8nKc7H3v7m2H3yqg4/1G6q8b8cYb9mOQ3W9bK1f1rQ4kQWQqE3nqV3z1s3m8Z2m9o8Wm6b9lX/2a0+3v8b3b6nA2lAlmJqCwqgQmZ+icxH3z8QmHtmwzGvV5KQv8D3Gv1wqZLf1v1wz8m7cFZKpQwzq9b6s9n+7V1n7y8n1n8qQpZ/b4mWjP2V8f7Hf2m0w3OQkEwUA0UA0UA0UAwxK2+uK7+eY3mM4fKc2h3e3bY9m1t+2mYw5m8b2m2k7m8JZbWbA3Gd7m0nHfY7GZp3m0eKXWn9b2m0fGfVb0oVQxU/manifestOK';
    const manifest={name:'Financy — Budget mobile & desktop',short_name:'Financy',start_url:'./',display:'standalone',background_color:'#0b5bff',theme_color:'#0b5bff',icons:[{src:iconPng,sizes:'192x192',type:'image/png'},{src:iconPng,sizes:'512x512',type:'image/png'}]};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'}); const url=URL.createObjectURL(blob); document.getElementById('manifestLink').setAttribute('href',url);
  })();

  // ====== Reset di emergenza via URL (?reset=1) ======
  (async function(){
    const params=new URLSearchParams(location.search);
    if(params.get('reset')==='1'){
      try{
        if('caches' in window){const keys=await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k)));}
        if('serviceWorker' in navigator){const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister()));}
        // Se vuoi anche pulire i dati, sblocca la riga sotto:
        // localStorage.removeItem(STORE_KEY);
        alert('Cache e Service Worker resettati. Ricarico l\'app…');
        location.replace(location.origin+location.pathname);
      }catch(e){console.warn('Reset error',e);}
    }
  })();

  // ====== Service Worker con versione cache alta per forzare update ======
  if('serviceWorker' in navigator){
    const swCode=`const CACHE='financy-cache-v100'; self.addEventListener('install',e=>{e.waitUntil((async()=>{const c=await caches.open(CACHE); await c.addAll(['./']); self.skipWaiting();})())}); self.addEventListener('activate',e=>self.clients.claim()); self.addEventListener('fetch',e=>{e.respondWith((async()=>{const r=await caches.match(e.request); return r||fetch(e.request);} )())});`;
    const blob=new Blob([swCode],{type:'text/javascript'}); const swUrl=URL.createObjectURL(blob); navigator.serviceWorker.register(swUrl);
  }

  // ====== Avvio ======
  window.addEventListener('load',()=>{setTimeout(()=>{const s=$('splash'); if(s){s.classList.add('fade-out'); setTimeout(()=>s.remove(),600);} },600);});
  function renderAll(){renderKPI();renderTx();renderCatList();renderBudget();$('budgetMonthLabel').textContent=`${state.activeMonth} ${state.activeYear}`;}
  initSelectors();bind();renderAll();show('dash');
  </script>
</body>
</html>
